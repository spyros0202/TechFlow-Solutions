{% extends "base.html" %}

{% block content %}

<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
    <p class="text-gray-600 mt-1">Monitor and manage your automation workflow</p>
</div>

<!-- Analytics Cards with Charts -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

    <!-- Status Distribution -->
    <div class="bg-white shadow-xl rounded-2xl p-6 border border-gray-100 hover:shadow-2xl hover:-translate-y-1">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-gray-700">
                Status Distribution
            </h2>
            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
            </div>
        </div>
        <div class="relative" style="height: 220px;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <!-- Source Types -->
    <div class="bg-white shadow-xl rounded-2xl p-6 border border-gray-100 hover:shadow-2xl hover:-translate-y-1">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-gray-700">
                Source Types
            </h2>
            <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
            </div>
        </div>
        <div class="relative" style="height: 220px;">
            <canvas id="sourceChart"></canvas>
        </div>
    </div>

    <!-- Daily Items -->
    <div class="bg-white shadow-xl rounded-2xl p-6 border border-gray-100 hover:shadow-2xl hover:-translate-y-1">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-gray-700">
                Items per Day
            </h2>
            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                </svg>
            </div>
        </div>
        <div class="relative" style="height: 220px;">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

</div>


<!-- Filters -->
<div class="mb-6">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">Filter by Status</h3>
    <div class="flex flex-wrap gap-3">
        <a href="?status=pending" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 text-sm font-medium shadow-md hover:shadow-lg hover:-translate-y-0.5">
            <span class="inline-block w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
            Pending
        </a>
        <a href="?status=approved" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-emerald-100 to-emerald-200 hover:from-emerald-200 hover:to-emerald-300 text-emerald-700 text-sm font-medium shadow-md hover:shadow-lg hover:-translate-y-0.5">
            <span class="inline-block w-2 h-2 bg-emerald-500 rounded-full mr-2"></span>
            Approved
        </a>
        <a href="?status=rejected" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-yellow-100 to-yellow-200 hover:from-yellow-200 hover:to-yellow-300 text-yellow-700 text-sm font-medium shadow-md hover:shadow-lg hover:-translate-y-0.5">
            <span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
            Rejected
        </a>
        <a href="?status=error" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-red-100 to-red-200 hover:from-red-200 hover:to-red-300 text-red-700 text-sm font-medium shadow-md hover:shadow-lg hover:-translate-y-0.5">
            <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-2"></span>
            Error
        </a>
        <a href="?status=all" class="px-4 py-2.5 rounded-xl bg-gradient-to-r from-blue-100 to-blue-200 hover:from-blue-200 hover:to-blue-300 text-blue-700 text-sm font-medium shadow-md hover:shadow-lg hover:-translate-y-0.5">
            <span class="inline-block w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
            All
        </a>
    </div>
</div>

<!-- Table -->
<div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-100">
    <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800">Recent Items</h3>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Source File</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
            </tr>
            </thead>

            <tbody class="divide-y divide-gray-200 bg-white">

            {% for item in items %}
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-medium text-gray-900">#{{ item.id }}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-medium bg-blue-100 text-blue-800 capitalize">
                        {{ item.source_type }}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <span class="text-sm text-gray-700">{{ item.source_file }}</span>
                </td>

                <td class="px-6 py-4 whitespace-nowrap">
                    {% if item.status == 'pending' %}
                        <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-gray-200 to-gray-300 rounded-full text-xs font-semibold text-gray-800 shadow-sm">
                            <span class="w-1.5 h-1.5 bg-gray-600 rounded-full mr-2"></span>
                            Pending
                        </span>
                    {% elif item.status == 'approved' %}
                        <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-emerald-200 to-emerald-300 rounded-full text-xs font-semibold text-emerald-800 shadow-sm">
                            <span class="w-1.5 h-1.5 bg-emerald-600 rounded-full mr-2"></span>
                            Approved
                        </span>
                    {% elif item.status == 'rejected' %}
                        <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-yellow-200 to-yellow-300 rounded-full text-xs font-semibold text-yellow-800 shadow-sm">
                            <span class="w-1.5 h-1.5 bg-yellow-600 rounded-full mr-2"></span>
                            Rejected
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-red-200 to-red-300 rounded-full text-xs font-semibold text-red-800 shadow-sm">
                            <span class="w-1.5 h-1.5 bg-red-600 rounded-full mr-2"></span>
                            Error
                        </span>
                    {% endif %}
                </td>

                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <a href="{% url 'detail' item.id %}"
                       class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 text-sm font-medium shadow-md hover:shadow-lg hover:-translate-y-0.5">
                        Review
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </a>
                </td>
            </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const statusCtx = document.getElementById("statusChart").getContext("2d");
    const sourceCtx = document.getElementById("sourceChart").getContext("2d");
    const dailyCtx = document.getElementById("dailyChart").getContext("2d");

    /* STATUS CHART (doughnut) */
    let statusChart = new Chart(statusCtx, {
        type: "doughnut",
        data: {
            labels: ["Pending", "Approved", "Rejected", "Error"],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ["#3b82f6", "#10b981", "#f59e0b", "#ef4444"],
                borderWidth: 3,
                borderColor: "#fff"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        font: { size: 11, weight: '600' },
                        padding: 12,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    /* SOURCE TYPE CHART (bar) */
    let sourceChart = new Chart(sourceCtx, {
        type: "bar",
        data: {
            labels: ["Forms", "Emails", "Invoices"],
            datasets: [{
                label: "Items",
                data: [0, 0, 0],
                backgroundColor: ["#3b82f6", "#8b5cf6", "#ec4899"],
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 0 },
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: { size: 10, weight: '500' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: { size: 11, weight: '600' }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    /* DAILY CHART (line) */
    let dailyChart = new Chart(dailyCtx, {
        type: "line",
        data: {
            labels: [],
            datasets: [
                { label: "Pending",  borderColor: "#3b82f6", backgroundColor: "rgba(59, 130, 246, 0.1)", data: [], fill: true, tension: 0.4, borderWidth: 2 },
                { label: "Approved", borderColor: "#10b981", backgroundColor: "rgba(16, 185, 129, 0.1)", data: [], fill: true, tension: 0.4, borderWidth: 2 },
                { label: "Rejected", borderColor: "#f59e0b", backgroundColor: "rgba(245, 158, 11, 0.1)", data: [], fill: true, tension: 0.4, borderWidth: 2 },
                { label: "Error",    borderColor: "#ef4444", backgroundColor: "rgba(239, 68, 68, 0.1)", data: [], fill: true, tension: 0.4, borderWidth: 2 },
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        font: { size: 10, weight: '600' },
                        padding: 10,
                        usePointStyle: true
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: { size: 9, weight: '500' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: { size: 8, weight: '500' },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    /* REFRESH FUNCTIONS */
    async function refreshStatus() {
        const resp = await fetch("/api/metrics/status/");
        if (!resp.ok) return;
        const data = await resp.json();

        statusChart.data.datasets[0].data = [
            data.pending || 0,
            data.approved || 0,
            data.rejected || 0,
            data.error || 0
        ];
        statusChart.update();
    }

    async function refreshSource() {
        const resp = await fetch("/api/metrics/source/");
        if (!resp.ok) return;
        const data = await resp.json();

        sourceChart.data.datasets[0].data = [
            data.form || 0,
            data.email || 0,
            data.invoice || 0
        ];
        sourceChart.update();
    }

    async function refreshDaily() {
        const resp = await fetch("/api/metrics/daily/");
        if (!resp.ok) return;
        const data = await resp.json();

        dailyChart.data.labels = data.map(row => row.date);
        dailyChart.data.datasets[0].data = data.map(row => row.pending);
        dailyChart.data.datasets[1].data = data.map(row => row.approved);
        dailyChart.data.datasets[2].data = data.map(row => row.rejected);
        dailyChart.data.datasets[3].data = data.map(row => row.error);
        dailyChart.update();
    }

    function refreshAll() {
        refreshStatus();
        refreshSource();
        refreshDaily();
    }

    refreshAll();
    setInterval(refreshAll, 10000);
});
</script>
{% endblock %}